#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

# fail fast
set -e

DOTNET_SDK_VERSION="1.0.4"
DOTNET_RUNTIME_VERSION="1.1.0"
LIBUNWIND_VERSION="1.1-4.1"

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
DEPLOYMENT_FILE_LOCATION=${BUILD_DIR}/.deployment

# Apt directory
mkdir -p ${BUILD_DIR}/.apt

# Download dependencies
APT_CACHE_DIR="$CACHE_DIR/apt/cache"
APT_STATE_DIR="$CACHE_DIR/apt/state"
APT_DIR_ETC_SOURCEPARTS="$CACHE_DIR/apt/dir_etc_sp"
APT_TEMP_KEYRING="$CACHE_DIR/apt/trusted.gpg"

mkdir -p "$APT_CACHE_DIR/archives/partial"
mkdir -p "$APT_STATE_DIR/lists/partial"
mkdir -p $APT_DIR_ETC_SOURCEPARTS

mkdir -p $BUILD_DIR/.apt

# Set up temp APT directory
cp /etc/apt/trusted.gpg $APT_TEMP_KEYRING
cp -Rf /etc/apt/sources.list.d $APT_DIR_ETC_SOURCEPARTS

APT_OPTIONS="-o debug::nolocking=true -o dir::etc:trusted=$APT_TEMP_KEYRING -o dir::etc::sourceparts=$APT_DIR_ETC_SOURCEPARTS -o dir::cache=$APT_CACHE_DIR -o dir::state=$APT_STATE_DIR"

apt $APT_OPTIONS update

# Essentials
apt $APT_OPTIONS -y --force-yes -d install --reinstall apt-transport-https

# libunwind
echo "Fetching libunwind"
apt $APT_OPTIONS -y --force-yes -d install --reinstall libunwind8

export LD_LIBRARY_PATH="$BUILD_DIR/.apt/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH"
export LD_LIBRARY_PATH="\$HOME/.apt/usr/lib/x86_64-linux-gnu:\$LD_LIBRARY_PATH"

# Download dotnet
echo "Fetching dotnet"
echo "deb [arch=amd64] https://apt-mo.trafficmanager.net/repos/dotnet-release/ xenial main" > $APT_DIR_ETC_SOURCEPARTS/dotnetdev.list
apt-key --keyring $APT_TEMP_KEYRING adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys 417A0893
apt $APT_OPTIONS update
apt $APT_OPTIONS -y --force-yes -d install --reinstall dotnet-dev-1.0.4

# Install everything
for DEB in $(ls -1 $APT_CACHE_DIR/archives/*.deb); do
  echo "Installing $(basename $DEB)"
  dpkg -x $DEB $BUILD_DIR/.apt/
done

export PATH="\$HOME/dotnet:\$PATH"

# Determine csproj location
if [ -e ${DEPLOYMENT_FILE_LOCATION} ]; then
  PROJECT_DIR=$BUILD_DIR/$(awk -F "=" '/project/ {print $2}' ${DEPLOYMENT_FILE_LOCATION} | tr -d ' ')
  CSPROJ_FILE=$(find $PROJECT_DIR -maxdepth 3 -iname "*.csproj")
	echo "Project file configured in .deployment file"
fi

# Compile and publish
cd $BUILD_DIR/$PROJECT_DIR
dotnet restore
dotnet publish ${CSPROJ_FILE} --output ${BUILD_DIR} $DNU_FLAGS --runtime ubuntu.16.04-x64 --configuration Release
